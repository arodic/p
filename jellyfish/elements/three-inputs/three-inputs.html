<script>
  (function() {
    var style = document.createElement('style');
    style.type = 'text/css';
    var css = 'body.ew-resize * {cursor: ew-resize}';
    style.appendChild(document.createTextNode(css));
    document.getElementsByTagName('head')[0].appendChild(style);
  })();
</script>

<polymer-element name="input-bool" attributes="value">
  <template>
    <link href="three-inputs.css" rel="stylesheet" type="text/css">
    <span class="checkbox {{value}}" on-click="{{toggle}}">&nbsp;</span>
  </template>
  <script>
    Polymer('input-bool', {
      toggle: function() {
        this.value = !this.value;
        this.fire('input-changed', this);
      }
    });
  </script>
</polymer-element>

<polymer-element name="input-string" attributes="value">
  <template>
    <link href="three-inputs.css" rel="stylesheet" type="text/css">
    <input type="text" id="value" value="{{value}}" on-keydown="{{handleKeyCodes}}" spellcheck="false"></input>
  </template>
  <script>
    Polymer('input-string', {
      handleKeyCodes: function(inEvent) {
        inEvent.stopPropagation();
        this.fire('input-changed', this);
      },
    });
  </script>
</polymer-element>

<polymer-element name="input-texture" attributes="value">
  <template>
    <input type="text" id="value" value="{{value.sourceFile}}" on-keydown="{{handleKeyCodes}}" spellcheck="false"></input>
    asset: {{value.sourceFile}}
    <div id="thumbnail"></div>
  </template>
  <script>
    Polymer('input-texture', {
      value: "",
      ready: function() {

        var scope = this;
        //TEMP for stratus
        function toBlob(data_url) {
          var d = atob(data_url.split(',')[1]);
          var b = new Uint8Array(d.length);
          for (var i = 0; i < d.length; i++) {
            b[i] = d.charCodeAt(i);
          }
          var type = data_url.split(',')[0].split(':')[1].split(';')[0];
          return new Blob([b], {type: type});
        }

        // drag and drop
        this.addEventListener( 'dragover', function ( event ) {
          event.preventDefault();
          event.stopPropagation();
          event.dataTransfer.dropEffect = 'copy';
        }, false );
        this.addEventListener( 'drop', function ( event ) {
          event.preventDefault();
          event.stopPropagation();
          var file = event.dataTransfer.files[ 0 ];
          var reader = new FileReader();
          reader.addEventListener( 'load', function ( event ) {
            var data = new FormData();
            data.append('blob', toBlob(event.target.result), file.name);
             $.get('/api/files/create', function(d) {
              $.ajax({
                type: 'POST',
                url: d.upload_url,
                data: data,
                cache: false,
                contentType: false,
                processData: false,
                success: function(items) {
                  var src = '/api/files/' + items[0].Id;
                  if (items[0].content_type == "video/mp4") {
                    scope.fire('texture-src-changed', {
                      texture: scope.value,
                      src: src,
                      isVideo: true
                    });
                  } else {
                    scope.fire('texture-src-changed', {
                      texture: scope.value,
                      src: src,
                      isVideo: false
                    });
                  }
                }
              });
            }); 

          }, false );
          reader.readAsDataURL(file);

        }, false );
      },
      valueChanged: function() {
        var scope = this;
        setTimeout(function(){
          scope.value.image = ShadowDOMPolyfill.wrapIfNeeded(scope.value.image);
          scope.value.image.setAttribute('width', '100%');
          scope.$.thumbnail.innerHTML = '';
          if (scope.value.isVideo) scope.value.image.play();
          scope.$.thumbnail.appendChild(scope.value.image);
          scope.value.needsUpdate = true;
        },1000);
      }
    })
  </script>
</polymer-element>

<polymer-element name="input-float" attributes="value step min max toDeg">
  <template>
    <link href="three-inputs.css" rel="stylesheet" type="text/css">
    <div id="blocker" on-dblclick="{{focus}}"></div>
    <input id="number" type="text" value="{{roundedValue}}" on-keydown="{{handleKeyCodes}}"></input>
  </template>
  <script>
    Polymer('input-float', {
      value: 0,
      roundedValue: 0,
      min: -Infinity,
      max: Infinity,
      step: 0.01,
      toDeg: false,
      ready: function() {
        var scope = this;
        var delta = 0;
        var deltaStep = 5;
        var x = 0;
        var y = 0;
        var xOld = 0;
        var rect;

        this.setAttribute('touch-action', 'none');

        var startDrag = function(event){
          event.preventDefault();
          event.stopPropagation();
          document.body.classList.add("ew-resize");
          xOld = event.clientX;
          delta = 0;
          document.activeElement.blur();
          document.addEventListener('mousemove', drag, false);
          document.addEventListener('mouseup', endDrag, false);
        };
        var endDrag = function(){
          document.body.classList.remove("ew-resize");
          document.removeEventListener('mousemove', drag, false);
          document.removeEventListener('mouseup', endDrag, false);
        };
        var drag = function(event) {
          event.preventDefault();
          event.stopPropagation();
          x = event.clientX;
          y = event.clientY;
          delta += x-xOld;
          xOld = event.clientX;

          while (Math.abs(delta)>deltaStep) {
            if (delta>deltaStep){
              scope.value += 1 * scope.step;
              delta -= deltaStep;
            }
            if (delta<-deltaStep){
              scope.value -= 1 * scope.step;
              delta += deltaStep;
            }
          }
          scope.value = Math.round(scope.value * 10000) / 10000;
          scope.value = Math.max(scope.value, scope.min);
          scope.value = Math.min(scope.value, scope.max);

          // scope.value = scope.roundedValue
          scope.fire('input-changed', scope);
        };
        var resetBlocker = function(){
          rect = scope.$.number.getBoundingClientRect();
          scope.$.blocker.style.width = rect.width + "px";
          scope.$.blocker.style.height = rect.height + "px";
        };
        var onblur = function() {
          // TODO: fix
          setTimeout(function(){
            var newValue = parseFloat(scope.roundedValue);
            if (!isNaN(newValue)) {
              if (scope.toDeg)
                scope.value = newValue/180*Math.PI;
              else
                scope.value = newValue;
            }
          },1);
        };
        this.addEventListener('mouseenter', resetBlocker);
        this.$.blocker.addEventListener('mousedown', startDrag);
        this.$.number.addEventListener('blur', onblur);
        this.$.number.onfocus = document.execCommand('selectAll',false,null);
      },
      focus: function() {
        this.$.number.focus();
        this.$.number.select();
      },
      handleKeyCodes: function(inEvent) {
        inEvent.stopPropagation();
        this.fire('input-changed', this);
        var validKeys = [46,48,49,50,51,52,53,54,55,56,57,189,190,37,38,39,40,8,9];
        var valid = false;
        for (var i in validKeys){
          if (inEvent.which == validKeys[i]) valid = true;
        }
        if (!valid) inEvent.preventDefault();
      },
      valueChanged: function() {
        if (this.toDeg)
          this.roundedValue = this.value/Math.PI*180;
        else
          this.roundedValue = this.value;

        this.roundedValue = Math.round(this.roundedValue * 10000) / 10000;
      }
    });
  </script>
</polymer-element>

<polymer-element name="input-vec2" attributes="value">
  <template>
    <link href="three-inputs.css" rel="stylesheet" type="text/css">
    <input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="x" class="half-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="y" class="half-width"></input-float>
  </template>
  <script>
    Polymer('input-vec2', {
      min: -Infinity,
      max: Infinity,
      step: 0.01,
      // ready: function() {
      //   this.addEventListener('input-changed', function(event) {
      //     event.stopPropagation()
      //     this.fire('input-changed', this)
      //   }) 
      // },
      valueChanged: function(){
        if ( window.THREE !== undefined && this.value instanceof THREE.Vector2 ) {
          this.$.x.bindProperty('value', new PathObserver(this.value, 'x'));
          this.$.y.bindProperty('value', new PathObserver(this.value, 'y'));
        } else if (this.value instanceof Array || this.value instanceof Float32Array) {
          this.$.x.bindProperty('value', new PathObserver(this.value, 0));
          this.$.y.bindProperty('value', new PathObserver(this.value, 1));
        }
      }
    });
  </script>
</polymer-element>

<polymer-element name="input-vec3" attributes="value">
  <template>
    <link href="three-inputs.css" rel="stylesheet" type="text/css">
    <input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="x" class="third-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="y" class="third-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="z" class="third-width"></input-float>
  </template>
  <script>
    Polymer('input-vec3', {
      min: -Infinity,
      max: Infinity,
      step: 0.01,
      valueChanged: function(){
        if ( window.THREE !== undefined && this.value instanceof THREE.Color ) {
          this.$.x.bindProperty('value', new PathObserver(this.value, 'r'));
          this.$.y.bindProperty('value', new PathObserver(this.value, 'g'));
          this.$.z.bindProperty('value', new PathObserver(this.value, 'b'));
        } else if (window.THREE !== undefined) {
          this.$.x.bindProperty('value', new PathObserver(this.value, 'x'));
          this.$.y.bindProperty('value', new PathObserver(this.value, 'y'));
          this.$.z.bindProperty('value', new PathObserver(this.value, 'z'));
        } else if (this.value instanceof Array || this.value instanceof Float32Array) {
          this.$.x.bindProperty('value', new PathObserver(this.value, 0));
          this.$.y.bindProperty('value', new PathObserver(this.value, 1));
          this.$.z.bindProperty('value', new PathObserver(this.value, 2));
        }
      }
    });
  </script>
</polymer-element>

<polymer-element name="input-vec4" attributes="value">
  <template>
    <link href="three-inputs.css" rel="stylesheet" type="text/css">
    <input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="x" class="quarter-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="y" class="quarter-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="z" class="quarter-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="w" class="quarter-width"></input-float>
  </template>
  <script>
    Polymer('input-vec4', {
      min: -Infinity,
      max: Infinity,
      step: 0.01,
      // ready: function() {
      //   this.addEventListener('input-changed', function(event) {
      //     event.stopPropagation()
      //     this.fire('input-changed', this)
      //   }) 
      // },
      valueChanged: function(){
        if ( window.THREE !== undefined && this.value instanceof THREE.Vector4 ) {
          this.$.x.bindProperty('value', new PathObserver(this.value, 'x'));
          this.$.y.bindProperty('value', new PathObserver(this.value, 'y'));
          this.$.z.bindProperty('value', new PathObserver(this.value, 'z'));
          this.$.w.bindProperty('value', new PathObserver(this.value, 'w'));
        } else if (this.value instanceof Array || this.value instanceof Float32Array) {
          this.$.x.bindProperty('value', new PathObserver(this.value, 0));
          this.$.y.bindProperty('value', new PathObserver(this.value, 1));
          this.$.z.bindProperty('value', new PathObserver(this.value, 2));
          this.$.w.bindProperty('value', new PathObserver(this.value, 4));
        }
      }
    });
  </script>
</polymer-element>

<polymer-element name="input-mat3" attributes="value">
  <template>
    <link href="three-inputs.css" rel="stylesheet" type="text/css">
    <input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m0" class="third-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m1" class="third-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m2" class="third-width"></input-float><br />
    <input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m3" class="third-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m4" class="third-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m5" class="third-width"></input-float><br />
    <input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m6" class="third-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m7" class="third-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m8" class="third-width"></input-float>
  </template>
  <script>
    Polymer('input-mat3', {
      min: -Infinity,
      max: Infinity,
      step: 0.01,
      ready: function() {
        this.addEventListener('input-changed', function(event) {
          event.stopPropagation();
          this.fire('input-changed', this);
        });
      },
      valueChanged: function(){
        this.$.m0.bindProperty('value', new PathObserver(this.value.elements, 0));
        this.$.m1.bindProperty('value', new PathObserver(this.value.elements, 1));
        this.$.m2.bindProperty('value', new PathObserver(this.value.elements, 2));
        this.$.m3.bindProperty('value', new PathObserver(this.value.elements, 3));
        this.$.m4.bindProperty('value', new PathObserver(this.value.elements, 4));
        this.$.m5.bindProperty('value', new PathObserver(this.value.elements, 5));
        this.$.m6.bindProperty('value', new PathObserver(this.value.elements, 6));
        this.$.m7.bindProperty('value', new PathObserver(this.value.elements, 7));
        this.$.m8.bindProperty('value', new PathObserver(this.value.elements, 8));
      }
    });
  </script>
</polymer-element>

<polymer-element name="input-mat4" attributes="value">
  <template>
    <link href="three-inputs.css" rel="stylesheet" type="text/css">
    <input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m0" class="quarter-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m1" class="quarter-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m2" class="quarter-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m3" class="quarter-width"></input-float><br />
    <input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m4" class="quarter-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m5" class="quarter-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m6" class="quarter-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m7" class="quarter-width"></input-float><br />
    <input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m8" class="quarter-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m9" class="quarter-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m10" class="quarter-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m11" class="quarter-width"></input-float><br />
    <input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m12" class="quarter-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m13" class="quarter-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m14" class="quarter-width"></input-float><input-float min="{{min}}" max="{{max}}" step="{{step}}" toDeg="{{toDeg}}" id="m15" class="quarter-width"></input-float>
  </template>
  <script>
    Polymer('input-mat4', {
      min: -Infinity,
      max: Infinity,
      step: 0.01,
      ready: function() {
        this.addEventListener('input-changed', function(event) {
          event.stopPropagation();
          this.fire('input-changed', this);
        });
      },
      valueChanged: function(){
        this.$.m0.bindProperty('value', new PathObserver(this.value.elements, 0));
        this.$.m1.bindProperty('value', new PathObserver(this.value.elements, 1));
        this.$.m2.bindProperty('value', new PathObserver(this.value.elements, 2));
        this.$.m3.bindProperty('value', new PathObserver(this.value.elements, 3));
        this.$.m4.bindProperty('value', new PathObserver(this.value.elements, 4));
        this.$.m5.bindProperty('value', new PathObserver(this.value.elements, 5));
        this.$.m6.bindProperty('value', new PathObserver(this.value.elements, 6));
        this.$.m7.bindProperty('value', new PathObserver(this.value.elements, 7));
        this.$.m8.bindProperty('value', new PathObserver(this.value.elements, 8));
        this.$.m9.bindProperty('value', new PathObserver(this.value.elements, 9));
        this.$.m10.bindProperty('value', new PathObserver(this.value.elements, 10));
        this.$.m11.bindProperty('value', new PathObserver(this.value.elements, 11));
        this.$.m12.bindProperty('value', new PathObserver(this.value.elements, 12));
        this.$.m13.bindProperty('value', new PathObserver(this.value.elements, 13));
        this.$.m14.bindProperty('value', new PathObserver(this.value.elements, 14));
        this.$.m15.bindProperty('value', new PathObserver(this.value.elements, 15));
      }
    });
  </script>
</polymer-element>
<link rel="import" href="../three-inputs/three-inputs.html">
<link rel="import" href="../div-showmore/div-showmore.html">

<polymer-element name="three-attribute-editor" attributes="model settings">
  <template>
    <link rel="stylesheet" href="three-attribute-editor.css">
    <div id="primaryAttributtes"></div>
    <div-showmore uuid="{{model.uuid}}">
      <div id="secondaryAttributtes"></div>
    </div-showmore>
  </template>
  <script>

    // var secondaryAttributes = [ 'eulerOrder', 'quaternion', 'useQuaternion' ];

    Polymer('three-attribute-editor', {
      model: undefined,
      settings: {},
      // primary: [
      //   'name',
      //   'position', 'rotation', 'scale', 'visible',
      //   'width', 'height', 'depth', 'near', 'far', 'fov', 'throwRatio', 'aspect', 'keystone', 'offset',
      //   'map', 'color', 'groundColor', 'ambient', 'emissive', 'intensity', 'distance', 'texture',
      //   'opacity', 'reflectivity', 'transparent', 'exponent',
      //   'widthSegments', 'heightSegments', 'depthSegment', 'radialSegments', 'tubularSegments',
      //   'radius', 'radiusTop', 'radiusBottom', 'phiStart', 'phiLength', 'thetaStart', 'thetaLength',
      //   'tube', 'arc', 'detail', 'p', 'q', 'heightScale', 'openEnded',
      //   'side', 'shading', 'wireframe', 'blending',
      //   'blendSrc', 'blendDst', 'blendEquation', 'depthTest', 'depthWrite'
      // ],
      ready: function() {
        this.setAttribute('touch-action', 'none');
        var scope = this;
        this.addEventListener('three-setmodel', function(event) {
          scope.model = event.detail.model;
        });
        window.addEventListener('three-attribute-changed', function(event){
          if (event.detail.attribute == 'selected') {
            if (event.detail.object && event.detail.object.selected) {
              scope.model = event.detail.object;
            } else {
              scope.model = {};
            }
          }
        });
        this.addEventListener('contextmenu', function() {
          event.preventDefault();
        });
      },
      modelChanged: function() {
        // todo: add deep binding
        for ( var attrib in this.model ) {
          var elem = new ThreeAttribute();
          elem.model = this.model;
          elem.attribute = attrib;
          if ( this.settings[ attrib ] ) {
            elem.settings = this.settings[ attrib ];
            this.$.primaryAttributtes.appendChild(elem);
          } else {
            this.$.secondaryAttributtes.appendChild(elem);
          }
        }
      }
    });
  </script>
</polymer-element>

<polymer-element name="three-attribute" attributes="model attribute settings" constructor="ThreeAttribute">
  <template>
    <link rel="stylesheet" href="three-attribute.css">
    <span id="label">{{attribute}}</span><div id="attribute"></div>
  </template>
  <script>
    Polymer('three-attribute', {
      model: undefined,
      attribute: undefined,
      ready: function() {
        var scope = this;

        this.setAttribute('touch-action', 'none');

        this.addEventListener('input-changed', function(event) {
          // todo
          if (window.THREE !== undefined && scope.model instanceof THREE.Camera) scope.model.updateProjectionMatrix();
          event.stopPropagation();
          scope.fire('three-attribute-changed', { object: scope.model, attribute: scope.attribute, value: event.detail.value });
        });
      },
      modelChanged: function() {
        var scope = this;

        var value = this.model[this.attribute];
        var type;

        if (typeof value == "boolean") type = "input-bool";
        else if (typeof value == "number") type = "input-float";
        else if (typeof value == "string") type = "input-string";

        var isVecArray = function ( object, length ) {
          if ((object instanceof Float32Array || object instanceof Array) && object.length == length ) {
            for (var i = object.length; i--;) {
              if (typeof object[i] !== "number") {
                return false;
              }
            }
            return true;
          }
          return false;
        };

        // TODO: make THREE-agnotic 
        if (window.THREE !== undefined && type === undefined) {
          if ( value instanceof THREE.Vector2 ) type = 'input-vec2';
          else if ( value instanceof THREE.Vector3 ) type = 'input-vec3';
          else if ( value instanceof THREE.Euler ) type = 'input-vec3';
          else if ( value instanceof THREE.Color ) type = 'input-vec3';
          else if ( value instanceof THREE.Vector4 ) type = 'input-vec4';
          else if ( value instanceof THREE.Quaternion ) type = 'input-vec4';
          else if ( value instanceof THREE.Matrix3 ) type = 'input-mat3';
          else if ( value instanceof THREE.Matrix4 ) type = 'input-mat4';
          else if ( value instanceof THREE.Texture ) type = 'input-texture';
        }

        if (type === undefined) {
          if ( isVecArray(value, 2) ) type = 'input-vec2';
          else if ( isVecArray(value, 3) ) type = 'input-vec3';
          else if ( isVecArray(value, 4) ) type = 'input-vec4';
        }

        if (type !== undefined) {
          this.inputElem = document.createElement(type);
          this.inputElem.bindProperty('value', new PathObserver(this.model, this.attribute));

          for (var setting in this.settings) {
            this.inputElem.bindProperty(setting, new PathObserver(this.settings, setting));
          }

          this.$.attribute.appendChild(this.inputElem);
          
          this.fire('three-input-ready', this);
        } else {
          this.$.label.className = 'linked';
          this.$.label.onclick = function() {
            scope.fire('three-setmodel', { model: scope.model[scope.attribute] } );
          };
        }

      }
    });

  </script>
</polymer-element>